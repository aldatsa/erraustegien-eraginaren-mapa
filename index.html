<!doctype html>

<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css/leaflet.css" />
        <link rel="stylesheet" href="css/leaflet.label.css" />
        <link rel="stylesheet" href="css/leaflet.fullscreen.css" />
        <link rel="stylesheet" href="css/L.Control.Window.css" />
        <link rel="stylesheet" href="css/estiloa.css" />
    </head>
    <body>
        <div id="bistaratze-aukerak">
            <label for="Zubieta">Zubieta</label>
            <input type="checkbox" id="Zubieta" checked>
            <label for="Rezola">Rezola</label>
            <input type="checkbox" id="Rezola" checked>
            <label for="Zabalgarbi">Zabalgarbi</label>
            <input type="checkbox" id="Zabalgarbi" checked>
        </div>
        <div id="mapa"></div>
        <script src="js/leaflet.js"></script>
        <script src="js/leaflet.label.js"></script>
        <script src="js/Leaflet.fullscreen.min.js"></script>
        <script src="js/L.Control.Window.js"></script>
        <script src="js/erraustegiak.js"></script>
        <script src="js/analytics.js"></script>
        <script>
            (function() {

                // URLaren parametroak eskuratzeko funtzioa.
                // http://stackoverflow.com/a/3855394/2855012
                var qs = (function(a) {
                    if (a == "") return {};
                    var b = {};
                    for (var i = 0; i < a.length; ++i)
                    {
                        var p=a[i].split('=', 2);
                        if (p.length == 1)
                            b[p[0]] = "";
                        else
                            b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
                    }
                    return b;
                })(window.location.search.substr(1).split('&'));

                var lat = qs["lat"] ? parseFloat(qs["lat"]) : 43.183376;
                var lng = qs["lng"] ? parseFloat(qs["lng"]) : -2.478662;
                var zoom = qs["zoom"] ? parseInt(qs["zoom"]) : 10;

                var mapa = L.map('mapa', {
                    fullscreenControl: true
                }).setView([lat, lng], zoom);

                var zirkuluak = [{
                    distantzia: 5000,
                    opakotasuna: 0.15
                }, {
                    distantzia: 10000,
                    opakotasuna: 0.12
                }, {
                    distantzia: 15000,
                    opakotasuna: 0.1
                }, {
                    distantzia: 20000,
                    opakotasuna: 0.1
                }];

                var erraustegiak = {
                    "Zubieta": {
                        izena: "Zubieta",
                        koordenatuak: [43.256308, -2.040659],
                        erraustegia: {}
                    },
                    "Rezola": {
                        izena: "Rezola",
                        koordenatuak: [43.285839, -1.997300],
                        erraustegia: {}
                    },
                    "Zabalgarbi": {
                        izena: "Zabalgarbi",
                        koordenatuak: [43.250402, -2.968665],
                        erraustegia: {}
                    }
                };

                var MapQuestOpen_OSM = L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/{type}/{z}/{x}/{y}.{ext}', {
                	type: 'map',
                	ext: 'jpg',
                	attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                	subdomains: '1234'
                });

                MapQuestOpen_OSM.addTo(mapa);

                //
                var kredituak = L.control({position: 'bottomleft'});

                kredituak.onAdd = function (map) {
                    var div = L.DomUtil.create('div', 'kredituak');

                    div.innerHTML = '<div>' +
                                        '<a href="http://www.argia.eus/" target="_blank"><img id="argia" src="img/argia.jpg"></a>' +
                                        '<a href="http://www.iametza.eus/" target="_blank"><img id="iametza" src="img/iametza.png"></a>' +
                                        '<div id="egilea"><strong>Asier Iturralde Sarasola</strong> <a href="http://aldatsa.eus" target="_blank">@aldatsa</a></div>' +
                                        '<div><a href="https://github.com/aldatsa/erraustegien-eraginpeko-zonaldeak" target="_blank">Iturburu kodea (GNU GPLv3)</a></div>' +
                                    '</div>';
                    return div;
                };

                kredituak.addTo(mapa);

                //
                var txertatzeko = L.control({position: 'topleft'});

                txertatzeko.onAdd = function (map) {

                    var div = L.DomUtil.create("div", "leaflet-bar txertatzeko-kodea");

                    div.innerHTML = "<a title='Txertatu mapa hau zure webgunean' href='#'></a>";

                    L.DomEvent.on(div, "click", function(event) {

                        event.preventDefault();

                        var txertatzeko_kodearen_leihoa =  L.control.window(mapa, {
                            title: "Txertatzeko kodea",
                            content: "<p>Mapa hau zure webgunean bistaratu nahi baduzu erabili txertatzeko kode hau:</p>" +
                                     "<textarea>&lt;iframe allowfullscreen='allowfullscreen' width='680' height='600' src='http://www.argia.eus/interaktiboak/2016-erraustegien-eraginpeko-zonaldeak/?lat=" + lat + "&lng=" + lng + "&zoom=" + zoom + "' frameBorder='0' scrolling='no'>&lt;/iframe></textarea>",
                            modal: true
                        });
                        
                        txertatzeko_kodearen_leihoa.show();
                    });

                    return div;
                };

                txertatzeko.addTo(mapa);

                for (var gakoa in erraustegiak) {

                    erraustegiak[gakoa].erraustegia = new Erraustegia(mapa, erraustegiak[gakoa].izena, erraustegiak[gakoa].koordenatuak, zirkuluak);

                    erraustegiak[gakoa].erraustegia.marraztuErraustegia();
                    erraustegiak[gakoa].erraustegia.marraztuZirkuluak();
                    erraustegiak[gakoa].erraustegia.gehituEtiketak();

                    (function(gakoa) {
                        document.getElementById(gakoa).addEventListener("click", function(event) {

                            var checkbox = event.target;

                            if (checkbox.checked) {
                                erraustegiak[gakoa].erraustegia.marraztuErraustegia();
                                erraustegiak[gakoa].erraustegia.marraztuZirkuluak();
                                erraustegiak[gakoa].erraustegia.gehituEtiketak();
                            } else {
                                erraustegiak[gakoa].erraustegia.ezabatuErraustegia();
                                erraustegiak[gakoa].erraustegia.ezabatuZirkuluak();
                                erraustegiak[gakoa].erraustegia.ezabatuEtiketak();
                            }
                        });
                    })(gakoa);
                }
            })();
        </script>
    </body>
</html>
