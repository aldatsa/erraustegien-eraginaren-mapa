<!doctype html>

<html>
    <head>
        <meta charset="utf-8">
        <link rel="stylesheet" href="css/leaflet.css" />
        <link rel="stylesheet" href="css/leaflet.label.css" />
        <link rel="stylesheet" href="css/leaflet.fullscreen.css" />
        <link rel="stylesheet" href="css/L.Control.Window.css" />
        <link rel="stylesheet" href="css/estiloa.css" />
    </head>
    <body>
        <div id="mapa"></div>
        <script src="js/leaflet.js"></script>
        <script src="js/leaflet.label.js"></script>
        <script src="js/Leaflet.fullscreen.min.js"></script>
        <script src="js/L.Control.Window.js"></script>
        <script src="js/topojson.v1.min.js"></script>
        <script src="js/erraustegiak.js"></script>
        <script src="js/analytics.js"></script>
        <script>
            (function() {

                // http://codepen.io/KryptoniteDove/post/load-json-file-locally-using-pure-javascript
                function loadJSON(file, callback) {

                    var xobj = new XMLHttpRequest();
                        xobj.overrideMimeType("application/json");
                    xobj.open('GET', file, true); // Replace 'my_data' with the path to your file
                    xobj.onreadystatechange = function () {
                          if (xobj.readyState == 4 && xobj.status == "200") {
                            // Required use of an anonymous callback as .open will NOT return a value but simply returns undefined in asynchronous mode
                            callback(xobj.responseText);
                          }
                    };
                    xobj.send(null);
                };

                // http://blog.webkid.io/maps-with-leaflet-and-topojson/
                L.TopoJSON = L.GeoJSON.extend({
                    addData: function(jsonData) {
                        if (jsonData.type === "Topology") {
                            for (key in jsonData.objects) {
                                geojson = topojson.feature(jsonData, jsonData.objects[key]);
                                L.GeoJSON.prototype.addData.call(this, geojson);
                            }
                        } else {
                            L.GeoJSON.prototype.addData.call(this, jsonData);
                        }
                    }
                });

                // URLaren parametroak eskuratzeko funtzioa.
                // http://stackoverflow.com/a/3855394/2855012
                var qs = (function(a) {
                    if (a == "") return {};
                    var b = {};
                    for (var i = 0; i < a.length; ++i)
                    {
                        var p=a[i].split('=', 2);
                        if (p.length == 1)
                            b[p[0]] = "";
                        else
                            b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
                    }
                    return b;
                })(window.location.search.substr(1).split('&'));

                var lat = qs["lat"] ? parseFloat(qs["lat"]) : 43.183376;
                var lng = qs["lng"] ? parseFloat(qs["lng"]) : -2.478662;
                var zoom = qs["zoom"] ? parseInt(qs["zoom"]) : 10;

                // Zein erraustegi bistaratu behar diren. Ez bada besterik esaten guztiak (atzerakako bateragarritasuna mantentzeko).
                // Array lehenetsia eskuz sartzea ez da oso dotorea. Horren ondorioz bi lekutan sartu behar da erraustegien zerrenda,
                // hemen eta erraustegiak aldagaian. Bateratzea komeni da.
                var zein = qs["zein"] ? qs["zein"].split(",") : ["Añorga", "Arrigorriaga", "Benesse-Maremne", "Lemoa", "Zabalgarbi", "Zubieta"];

                var mapa = L.map('mapa', {
                    fullscreenControl: true
                }).setView([lat, lng], zoom);

                var zirkuluak = [{
                    distantzia: 5000,
                    opakotasuna: 0.15,
                    marra: 5
                }, {
                    distantzia: 10000,
                    opakotasuna: 0.12,
                    marra: 5
                }, {
                    distantzia: 15000,
                    opakotasuna: 0.1,
                    marra: 5
                }, {
                    distantzia: 20000,
                    opakotasuna: 0.1,
                    marra: 5
                }];

                var erraustegiak = {
                    "Añorga": {
                        izena: "Añorga",
                        koordenatuak: [43.285839, -1.997300],
                        erraustegia: {}
                    },
                    "Arrigorriaga": {
                        izena: "Arrigorriaga",
                        koordenatuak: [43.205361, -2.899579],
                        erraustegia: {}
                    },
                    "Benesse-Maremne": {
                        izena: "Benesse-Maremne",
                        koordenatuak: [43.6307425,-1.4004349],
                        erraustegia: {}
                    },
                    "Lemoa": {
                        izena: "Lemoa",
                        koordenatuak: [43.206014, -2.773567],
                        erraustegia: {}
                    },
                    "Zabalgarbi": {
                        izena: "Zabalgarbi",
                        koordenatuak: [43.250402, -2.968665],
                        erraustegia: {}
                    },
                    "Zubieta": {
                        izena: "Zubieta",
                        koordenatuak: [43.256308, -2.040659],
                        erraustegia: {}
                    }
                };

                var MapQuestOpen_OSM = L.tileLayer('http://otile{s}.mqcdn.com/tiles/1.0.0/{type}/{z}/{x}/{y}.{ext}', {
                	type: 'map',
                	ext: 'jpg',
                	attribution: 'Tiles Courtesy of <a href="http://www.mapquest.com/">MapQuest</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                	subdomains: '1234'
                });

                MapQuestOpen_OSM.addTo(mapa);

                //
                var kredituak = L.control({position: 'bottomleft'});

                kredituak.onAdd = function (mapa) {
                    var div = L.DomUtil.create('div', 'kredituak');

                    div.innerHTML = '<div>' +
                                        '<a href="http://www.argia.eus/" target="_blank"><img id="argia" src="img/argia.jpg"></a>' +
                                        '<a href="http://www.iametza.eus/" target="_blank"><img id="iametza" src="img/iametza.png"></a>' +
                                        '<div id="egilea"><strong>Asier Iturralde Sarasola</strong> <a href="http://aldatsa.eus" target="_blank">@aldatsa</a></div>' +
                                        '<div><a href="https://github.com/aldatsa/erraustegien-eraginpeko-zonaldeak" target="_blank">Iturburu kodea (GNU GPLv3)</a></div>' +
                                    '</div>';
                    return div;
                };

                kredituak.addTo(mapa);

                var bistaratze_aukerak = L.control({position: "topright"});

                bistaratze_aukerak.onAdd = function(mapa) {

                    var div = L.DomUtil.create("div", "bistaratze-aukerak leaflet-bar");

                    var kontrolak = "";

                    var checked = "";

                    for (var gakoa in erraustegiak) {

                        checked = "";

                        // Erraustegia bistaratu behar da?
                        if (zein.indexOf(gakoa) > -1) {

                            checked = " checked";

                        }

                        kontrolak = kontrolak +
                                    "<span>" +
                                        "<input type='checkbox' id='" + gakoa + "'" + checked + ">" +
                                        "<label for='" + gakoa + "'>" + gakoa + "</label>" +
                                    "</span>";
                    }

                    div.innerHTML = kontrolak;

                    return div;
                };

                bistaratze_aukerak.addTo(mapa);

                //
                var txertatzeko = L.control({position: 'topleft'});

                txertatzeko.onAdd = function (map) {

                    var div = L.DomUtil.create("div", "leaflet-bar txertatzeko-kodea");

                    div.innerHTML = "<a title='Txertatu mapa hau zure webgunean' href='#'></a>";

                    L.DomEvent.on(div, "click", function(event) {

                        event.preventDefault();

                        var txertatzeko_kodearen_leihoa =  L.control.window(mapa, {
                            title: "Txertatzeko kodea",
                            content: "<p>Mapa hau zure webgunean bistaratu nahi baduzu erabili txertatzeko kode hau:</p>" +
                                     "<textarea>&lt;iframe allowfullscreen='allowfullscreen' width='680' height='600' src='http://www.argia.eus/interaktiboak/2016-erraustegien-eraginpeko-zonaldeak/?lat=" + lat + "&lng=" + lng + "&zoom=" + zoom + "' frameBorder='0' scrolling='no'>&lt;/iframe></textarea>",
                            modal: true
                        });

                        txertatzeko_kodearen_leihoa.show();
                    });

                    return div;
                };

                txertatzeko.addTo(mapa);

                for (var gakoa in erraustegiak) {

                    erraustegiak[gakoa].erraustegia = new Erraustegia(mapa, erraustegiak[gakoa].izena, erraustegiak[gakoa].koordenatuak, zirkuluak);

                    // Erraustegia bistaratu behar da?
                    if (zein.indexOf(gakoa) > -1) {

                        erraustegiak[gakoa].erraustegia.marraztuErraustegia();
                        erraustegiak[gakoa].erraustegia.marraztuZirkuluak();
                        erraustegiak[gakoa].erraustegia.gehituEtiketak();

                    }

                    (function(gakoa) {
                        document.getElementById(gakoa).addEventListener("click", function(event) {

                            var checkbox = event.target;

                            if (checkbox.checked) {
                                erraustegiak[gakoa].erraustegia.marraztuErraustegia();
                                erraustegiak[gakoa].erraustegia.marraztuZirkuluak();
                                erraustegiak[gakoa].erraustegia.gehituEtiketak();
                            } else {
                                erraustegiak[gakoa].erraustegia.ezabatuErraustegia();
                                erraustegiak[gakoa].erraustegia.ezabatuZirkuluak();
                                erraustegiak[gakoa].erraustegia.ezabatuEtiketak();
                            }
                        });
                    })(gakoa);
                }

                var topoLayer = new L.TopoJSON();

                loadJSON("topoJSON/herrialdeak.topo.json", function(response) {
                    // Parse JSON string into object
                    var data = JSON.parse(response);

                    var topoLayer = new L.TopoJSON(data, {
                        style: function (feature) {
                            return {
                                color: "#555",
                                opacity: 1,
                                "fillOpacity": 0,
                                weight: 2
                            };
                        }
                    }).addTo(mapa);
                });
            })();
        </script>
    </body>
</html>
